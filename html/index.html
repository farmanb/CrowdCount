<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"  
"http://www.w3.org/TR/xhtml11/DTD/xhtml1-strict.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <title>Crowd Counter</title>
    <!--Tyr-->
    <!--<script src="https://www.google.com/jsapi?key=ABQIAAAA7t2ISUFvNpKam51yH5J1NRQW5c9LSTyO-0ic3WvONgl-qkQNHxRwato0TMRVTk8nTdUAnst5xsDcYw" type="text/javascript"></script>-->
    <!--CEMS-->
    <script src="https://www.google.com/jsapi?key=ABQIAAAA7t2ISUFvNpKam51yH5J1NRTug3FjRBdPteh6E-oE1d6ZZp9bMxRgGpaC2dF1zrNdj9g-HV0pM41Gow" type="text/javascript"></script>
    
    <script language="Javascript" type="text/javascript">
    google.load("jquery", "1");
google.load("maps", "3", {other_params: "sensor=false"});

var city, state, country, latitude, longitude;

function count(){
    var xmlhttp = new XMLHttpRequest();
    $("#status").html("Sending...");
    
    xmlhttp.onreadystatechange = function(){
	if (xmlhttp.readyState == 4){
	    $("#status").html("Counted.");
	}
    }
    xmlhttp.open("GET", "dbInteraction.php?city=" + city + "&state=" + state + "&country=" + country + "&latitude=" + latitude + "&longitude=" + longitude, true);
    xmlhttp.send();

    displayCount();
}

    function displayCount(){
        var countReq = new XMLHttpRequest();
	
	countReq.onreadystatechange = function(){
	  if (countReq.readyState == 4){
	     $("#countPlaceholder").html(countReq.responseText);
	    }
	}

	countReq.open("GET", "getCount.php?city=" + city + "?state=" + state + "?country=" + country, true);
	countReq.send();
    }

google.setOnLoadCallback(function() {
    var geocoder = new google.maps.Geocoder();
    if (navigator.geolocation){
	//$("#browserSupported").html("Your browser is supported.");
	navigator.geolocation.getCurrentPosition(function(position){
	    latitude = position.coords.latitude;
	    longitude = position.coords.longitude;
	    var location = "Lat: " + latitude + ", Long: " + longitude;    
	    //$("#yourLatLong").html(location);
	    
	    var pos = new google.maps.LatLng(position.coords.latitude, position.coords.longitude);
	    geocoder.geocode({'latLng': pos}, function(results, status){
		if (status == google.maps.GeocoderStatus.OK){
		    var components = results[1].address_components;
		    
		    /*Get the city, state and country.*/
		    for (i in components){
			var compTypes = components[i].types
			for (j in compTypes){
			    if (compTypes[j] == 'locality'){
				city = components[i].short_name;
			    }
			    if (compTypes[j] == 'administrative_area_level_1'){
				state = components[i].short_name;
			    }
			    if (compTypes[j] == 'country'){
				country = components[i].short_name;
			    }
			}
		    }
		    $("#yourLocation").html("Your Location: " + city + ", " + state + ", " + country);
		    
		}
		else{
		    $("#yourLocation").html("Error: " + status + ".");
		}
	    });
	},
						 function(error){
						     $("#error").html("Error: " + geolocationErrorMessages[error.code] + ".");
						 },
						 {enableHighAccuracy: true, maximumAge:120000});
    }
    else{
	$("#browserSupported").html("Your browser is not supported");
    }
});
</script>
  </head>
  <body>
    <form>
    <p>
    <span id="yourLocation"></span>
    </p>
    <p>
    <button type="button" onclick="count()">Count Me</button>
    </p>
    <p>
    <span id="status"></span>
    </p>
    </form>
    <p>
      <span id="browserSupported"></span>
      <span id="yourLatLong"></span>
    </p>
    <span id="error"></span>
  </p>
  <p>
  <span id="countPlaceholder"></span>
  </p>
  </body>
</html>
